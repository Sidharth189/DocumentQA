<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>DocumentQA</title>
  <link rel="stylesheet" href="styles.css" />
  <meta name="description" content="Document QA â€” Upload documents and ask questions" />
</head>
<body>
  <main class="container">
    <header class="header">
      <h1>ðŸ“„ DocumentQA</h1>
      <p class="tagline">Upload documents and ask questions powered by AI</p>
    </header>

    <!-- Upload Section -->
    <section class="card upload-section">
      <h2>Upload Document</h2>
      <form id="uploadForm" class="upload-form" enctype="multipart/form-data">
        <div class="file-input-wrapper">
          <input type="file" id="fileInput" accept=".pdf,.txt,.docx,.doc" required />
          <span class="file-label">Choose a file (PDF, TXT, DOCX)</span>
        </div>
        <button type="submit" class="btn btn-primary">Upload & Process</button>
        <div id="uploadStatus" class="status-message"></div>
      </form>
    </section>

    <!-- Chat Section -->
    <section class="card chat-section">
      <h2>Chat</h2>
      <div class="chat-box">
        <div id="chatMessages" class="chat-messages">
          <div class="chat-welcome">Start by asking a question about your documents.</div>
        </div>
        <form id="queryForm" class="chat-form">
          <textarea
            id="queryInput"
            placeholder="Ask a question..."
            rows="3"
            required
          ></textarea>
          <button type="submit" class="btn btn-primary">Send</button>
        </form>
        <div id="queryStatus" class="status-message"></div>
      </div>
    </section>

    <footer class="footer">
      <small>DocumentQA â€” Minimal HTML/CSS Frontend</small>
    </footer>
  </main>

  <script>
    const API_BASE = "http://localhost:8000";

    // Upload document
    document.getElementById("uploadForm").addEventListener("submit", async (e) => {
      e.preventDefault();
      const fileInput = document.getElementById("fileInput");
      const file = fileInput.files[0];
      const statusDiv = document.getElementById("uploadStatus");

      if (!file) {
        statusDiv.textContent = "Please select a file.";
        statusDiv.className = "status-message error";
        return;
      }

      const formData = new FormData();
      formData.append("file", file);

      statusDiv.textContent = "Uploading...";
      statusDiv.className = "status-message info";

      try {
        const response = await fetch(`${API_BASE}/ingest`, {
          method: "POST",
          body: formData,
        });

        if (!response.ok) {
          throw new Error(`HTTP ${response.status}`);
        }

        const data = await response.json();
        statusDiv.textContent = `âœ“ ${data.message || "Upload successful"}`;
        statusDiv.className = "status-message success";
        fileInput.value = "";
      } catch (error) {
        statusDiv.textContent = `âœ— Error: ${error.message}`;
        statusDiv.className = "status-message error";
      }
    });

    // Query API
    document.getElementById("queryForm").addEventListener("submit", async (e) => {
      e.preventDefault();
      const queryInput = document.getElementById("queryInput");
      const query = queryInput.value;
      const statusDiv = document.getElementById("queryStatus");
      const chatMessages = document.getElementById("chatMessages");

      if (!query.trim()) {
        statusDiv.textContent = "Please enter a question.";
        statusDiv.className = "status-message error";
        return;
      }

      // Remove welcome message if present
      const welcome = chatMessages.querySelector(".chat-welcome");
      if (welcome) welcome.remove();

      // Add user message
      const userMsg = document.createElement("div");
      userMsg.className = "chat-message user-message";
      userMsg.textContent = query;
      chatMessages.appendChild(userMsg);
      queryInput.value = "";

      statusDiv.textContent = "Searching...";
      statusDiv.className = "status-message info";

      try {
        const response = await fetch(`${API_BASE}/ask`, {
          method: "POST",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify({ query, top_k: 5 }),
        });

        if (!response.ok) {
          throw new Error(`HTTP ${response.status}`);
        }

        const data = await response.json();
        statusDiv.textContent = "âœ“ Answer received";
        statusDiv.className = "status-message success";

        // Add bot message
        const botMsg = document.createElement("div");
        botMsg.className = "chat-message bot-message";
        botMsg.innerHTML = `
          <div class="bot-answer">${data.answer || data.result || JSON.stringify(data)}</div>
          ${
            data.sources && data.sources.length > 0
              ? `
            <div class="bot-sources">
              <strong>Sources:</strong>
              <ul>
                ${data.sources.map((s) => `<li>${s}</li>`).join("")}
              </ul>
            </div>
          `
              : ""
          }
        `;
        chatMessages.appendChild(botMsg);
        chatMessages.scrollTop = chatMessages.scrollHeight;
      } catch (error) {
        statusDiv.textContent = `âœ— Error: ${error.message}`;
        statusDiv.className = "status-message error";
      }
    });
  </script>
</body>
</html>
